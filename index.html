<!doctype html>
<html>
<head>
<style type="text/css">
body {
	font-size: 11px;
	font-family: monospace;
}

table.circle_output td {
	border-collapse: collapse;
}
table.circle_output td {
	border: 1px solid white;
	width: 15px;
	height: 15px;
}

.filled {
	background: red;
}

.cgy0, .cgx0 {
	background: #eee;
}

.filled.cgy0, .filled.cgx0 {
	background: #808080;
}

#height, #diameter, #scaler {
	width: 150px;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/mootools/1.4.5/mootools-yui-compressed.js"></script>
<script src="range-polyfill.js"></script>
<script src="number-polyfill.js"></script>
<script>
window.addEvent('domready', function(){
	var dia         = $('diameter');
	var height      = $('height');
	var resultblock = $('result');
	var scaler      = $('scaler');
	var linked      = $('linked');
	var thickness   = $('thickness');
	var blockcount  = $('blockcount');

	var distance = function(x, y, ratio) {
		return Math.sqrt((Math.pow(y * ratio, 2)) + Math.pow(x, 2));
	}

	var filled = function(x, y, radius, ratio) {
		return distance(x, y, ratio) <= radius;
	}

	var fatfilled = function(x, y, radius, ratio) {
		return filled(x, y, radius, ratio) && !( 
			filled(x + 1, y, radius, ratio) &&
			filled(x - 1, y, radius, ratio) &&
			filled(x, y + 1, radius, ratio) &&
			filled(x, y - 1, radius, ratio) &&
			filled(x + 1, y + 1, radius, ratio) &&
			filled(x + 1, y - 1, radius, ratio) &&
			filled(x - 1, y - 1, radius, ratio) &&
			filled(x - 1, y + 1, radius, ratio)
		);
	}

	function Svg_renderer() {
		var _inner_content = '';
		var _svg_width  = 1;
		var _svg_height = 1;

		var _max_x = 0;
		var _max_y = 0;

		this.init = function(max_x, max_y){
			_max_x = max_x;
			_max_y = max_y;
			_svg_width  = 10 * max_x;
			_svg_height = 10 * max_y;
			_inner_content = '';
		}

		this.add = function(x, y, filled) {
			if(filled) {
				_inner_content += '<rect x="'+((x * 10) + (_svg_width/2) - 10)+'" y="'+((y * 10) + (_svg_height/2) - 10)+'" fill="#FF0000" width="9" height="9"/>';
			}
		};

		this.render = function(){
			var text = '';
			text += '<svg id="svg_circle" xmlns="http://www.w3.org/2000/svg" width="'+_svg_width+'px" height="'+_svg_height+'px" viewBox="0 0 '+_svg_width+' '+_svg_height+'">';
			text += _inner_content;
			text += '</svg>';

			return text;
		};

		this.scale = function(scale){
			var svgc = $$('#svg_circle');

			svgc.set('width', scale + 'px');
			svgc.set('height', scale + 'px');
		};
	}

	function Table_renderer() {
		var _row_data = {};
		var _max_y;

		this.init = function(max_x, max_y){
			_max_x = max_x;
			_max_y = max_y;
			_row_data = {};
		}

		this.add = function(x, y, filled) {
			var offset_y = y + _max_y;
			if(typeof _row_data[offset_y] == "undefined") { _row_data[offset_y] = ''; }
			_row_data[offset_y] += '<td class="'+(filled ? 'filled' : '')+' cgx'+x+' cgy'+y+'"></td>';
		};

		this.render = function(){
			var text = '';
			text += '<table class="circle_output">';

			for( row in _row_data ) {
				if( _row_data.hasOwnProperty(row) ) {
					text += '<tr>'+ _row_data[row] +'</tr>';
				}
			}
			text += '</table>';

			return text;
		};

		this.scale = function(scale){
			var tdwidth = scale / _max_x;
			$$('table.circle_output td').setStyles({'width': tdwidth,'height': tdwidth}); 
		};
	}

	var renderer = new Svg_renderer();

	var draw = function(){
		var thick_t = thickness.get('value');
		var width_r = parseFloat(dia.value, 10) / 2;
		var height_r = parseFloat(height.value, 10) / 2;
		var ratio = width_r / height_r;

		var maxblocks_x, maxblocks_y;
		//var text = '';
		var ifilled = 0;

		if ( (width_r * 2) % 2 == 0 ) {
			maxblocks_x = Math.ceil(width_r - .5) * 2 + 1;
		} else {
			maxblocks_x = Math.ceil(width_r) * 2;	
		}

		if ( (height_r * 2) % 2 == 0 ) {
			maxblocks_y = Math.ceil(height_r - .5) * 2 + 1;
		} else {
			maxblocks_y = Math.ceil(height_r) * 2;	
		}

		renderer.init( maxblocks_x, maxblocks_y, 1 );
		var hash = [width_r, height_r, thick_t].join();
		
		if( resultblock.get('data-hash') != hash ) {

			for (var y = -maxblocks_y / 2 + 1; y <= maxblocks_y / 2 - 1; y++) {
				for (var x =- maxblocks_x / 2 + 1; x <= maxblocks_x / 2 - 1; x++) {
					var xfilled;

					if( thick_t == 'thick' ) {
						xfilled = fatfilled(x, y, width_r, ratio);
					}else if( thick_t == 'thin' ){
						xfilled = fatfilled(x, y, width_r, ratio) && 
							!(fatfilled(x + (x > 0 ? 1 : -1), y, width_r, ratio) && fatfilled(x, y + (y > 0 ? 1 : -1), width_r, ratio));

					}else{
						xfilled = filled(x, y, width_r, ratio);
					}

					ifilled += (!!xfilled) * 1;

					renderer.add( x, y, xfilled );
				}
			}
			
			resultblock.set('data-hash', hash);
			resultblock.innerHTML = renderer.render();
			blockcount.set('html', ifilled);
		}

		rescale();
	}

	var rescale = function(){
		renderer.scale(scaler.value);
	};

	var sizechange = function(){
		if(linked.checked) {
			if(this.get('id') == height.get('id')) {
				diameter.set('value', height.get('value'));
			}else{
				height.set('value', diameter.get('value'));
			}
		}
		draw();
	}

	$$(dia, height, linked, thickness).addEvent('keyup', sizechange).addEvent('change', sizechange);

	scaler.addEvent('change', rescale);

	draw();
});

</script>
</head>

<body>
Width : 
<input type="number" size="5" id="diameter" value="9" autocomplete="off" autofocus="autofocus">
<label><input id="linked" type="checkbox" checked="checked" value="1" /> Linked</label>
&mdash;
Block Count: <span id="blockcount"></span><br />
Height:
<input type="number" size="5" id="height" value="9" autocomplete="off" autofocus="autofocus"> 
<select id="thickness"><option>thick</option><option>thin</option><option>filled</option></select>
<br />
Scale :
<input type="range" min="50" max="2000" value="300" id="scaler" data-poly-scale=".1" />
<br />

<div id="result"></div>

</body>
</html>